<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EAS Finance | Bridge-to-Let Analyser</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* --- CORE STYLES --- */
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; color: #333; }
  .wrap { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
  h1 { margin-top: 0; color: #0d2e48; border-bottom: 2px solid #eee; padding-bottom: 15px; text-align: center; }
  
  /* Buttons */
  .btnbar { margin-bottom: 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
  button { padding: 10px 20px; border: 1px solid #ccc; background: #fff; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
  button:hover { background: #f0f0f0; }
  button.primary { background: #0d2e48; color: white; border-color: #0d2e48; }
  button.primary:hover { background: #1a4a70; }
  button.action { background: #27ae60; color: white; border-color: #27ae60; }
  button.action:hover { background: #219150; }
  
  /* Tabs */
  .tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; gap: 5px; overflow-x: auto; }
  .tabbtn { padding: 12px 20px; background: #f9f9f9; border: 1px solid #e0e0e0; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; color: #666; font-weight: 500; white-space: nowrap; }
  .tabbtn.active { background: #fff; color: #0d2e48; font-weight: bold; border-top: 3px solid #0d2e48; border-bottom: 2px solid #fff; margin-bottom: -2px; }
  .tabpage { display: none; }
  .tabpage.active { display: block; animation: fadeIn 0.3s; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
  
  /* Tables & Inputs */
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; }
  td, th { padding: 10px 12px; border-bottom: 1px solid #eee; vertical-align: middle; }
  th { text-align: left; background: #f8f9fa; color: #555; font-weight: 600; }
  .section-header { background: #eef2f5; padding: 10px 15px; font-weight: 700; color: #0d2e48; margin-top: 25px; border-radius: 4px; border-left: 5px solid #0d2e48; }
  
  input, select { width: 100%; padding: 8px 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
  input:focus { border-color: #0d2e48; outline: none; }
  
  /* Tooltips */
  .help { cursor: help; border-bottom: 1px dashed #999; text-decoration: none; color: inherit; }

  /* Outputs */
  .cellOutput { font-family: 'Consolas', monospace; font-weight: 700; text-align: right; color: #0d2e48; }
  .right { text-align: right; }
  .center { text-align: center; }
  
  /* Chart Containers */
  .chart-container { position: relative; height: 250px; width: 100%; }

  .kpiGrid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
  @media(max-width:768px) { .kpiGrid { grid-template-columns: 1fr; } }
  .card { border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; background: #fff; }
  .card h3 { background: #fff; padding: 15px; margin: 0; border-bottom: 1px solid #e0e0e0; font-size: 16px; color: #0d2e48; }
  .card .body { padding: 15px; }
  
  .highlight-green { color: #27ae60; font-weight: bold; }
  .highlight-red { color: #c0392b; font-weight: bold; }
  .note { font-size: 12px; color: #666; display: block; margin-top: 4px; font-style: italic; }
  .disclaimer { font-size: 11px; color: #888; text-align: center; margin-top: 15px; font-style: italic; background:#f9f9f9; padding:8px; border-radius:4px; }

  /* --- PRINT STYLES (Make Ctrl+P look like a report) --- */
  @media print {
      body { background: white; padding: 0; }
      .wrap { box-shadow: none; max-width: 100%; padding: 0; }
      .btnbar, .tabs, .disclaimer, .note { display: none !important; }
      .tabpage { display: block !important; } /* Show all content */
      .card { break-inside: avoid; border: 1px solid #ccc; margin-bottom: 20px; }
      h1 { font-size: 24px; text-align: left; }
      /* Hide elements not needed for print */
      #tab-inputs, #tab-cash { display: none !important; } /* Only print Dashboard & Detail */
      .tabpage.active { display: block !important; }
  }
</style>
</head>
<body>
 
<div class="wrap">
  <h1>EAS Finance | Bridge-to-Let Analyser</h1>
 
  <div class="btnbar">
    <button class="primary" id="btnResetZero" type="button">Reset Inputs</button>
    <button class="action" id="btnEmailQuote" type="button">ðŸ“§ Create Email Summary</button>
  </div>
 
  <div class="tabs">
    <button class="tabbtn active" data-tab="dash" type="button">Dashboard</button>
    <button class="tabbtn" data-tab="inputs" type="button">Inputs (Edit)</button>
    <button class="tabbtn" data-tab="outputs" type="button">Detailed Outputs</button>
    <button class="tabbtn" data-tab="cash" type="button">Cashflows</button>
  </div>
 
  <div id="tab-dash" class="tabpage active">
    
    <div class="disclaimer" style="margin-bottom: 20px; text-align:left; border-left: 3px solid #ccc;">
      <b>Assumptions:</b> Bridge interest is retained; Refinance is interest-only; Rental growth fixed at 3% p.a. for projections. Lender criteria vary.
    </div>

    <div class="kpiGrid">
      
      <div class="card">
        <h3>Borrowing Power (5-Year vs 2-Year)</h3>
        <div class="body">
          <div class="chart-container">
            <canvas id="chartLeverage"></canvas>
          </div>
          <p class="center" style="font-size:13px; margin-top:10px;">
            5-Year Term unlocks <span id="kpiExtraLev" class="highlight-green">Â£0</span> extra capital
          </p>
        </div>
      </div>

      <div class="card">
        <h3>Project Cost Breakdown</h3>
        <div class="body">
          <div class="chart-container">
            <canvas id="chartCosts"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Deal Viability</h3>
        <div class="body">
          <table style="margin:0">
            <tr><td><span class="help" title="Total Project Cost (Purchase + Works + Fees + Finance)">Total GDC</span></td><td class="cellOutput" id="kpiGdc">-</td></tr>
            <tr><td><b>Money Left In Deal</b></td><td class="cellOutput highlight-red" id="kpiMoneyLeftIn">-</td></tr>
            <tr><td><span class="help" title="Paper profit: End Value (GDV) minus Total Cost (GDC)">Value Uplift (Paper)</span></td><td class="cellOutput highlight-green" id="kpiProfit">-</td></tr>
            <tr><td>ROI (on Cash Left In)</td><td class="cellOutput" id="kpiRoi">-</td></tr>
            <tr><td>Yield (Net)</td><td class="cellOutput" id="kpiYield">-</td></tr>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>Refinance Stress Test</h3>
        <div class="body">
          <table style="margin:0">
            <thead>
              <tr style="font-size:12px; color:#666"><th>Test Type</th><th class="right">Stress Rate</th><th class="right">Max Loan</th></tr>
            </thead>
            <tbody>
              <tr>
                <td>Typical 2-Year Stress</td>
                <td class="right" id="kpiStressStd">-</td>
                <td class="right" id="kpiLoan2yr">-</td>
              </tr>
              <tr style="background:#e8f5e9">
                <td style="font-weight:bold; color:#27ae60">Typical 5-Year Stress</td>
                <td class="right" id="kpiStress5yr">-</td>
                <td class="right highlight-green" id="kpiLoan5yr">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
 
  <div id="tab-inputs" class="tabpage">
    
    <div class="kpiGrid">
      <div>
        <div class="section-header">1. Purchase & Costs</div>
        <table>
          <tr><td>Purchase Price (Â£)</td><td><input type="number" id="inPurchase" value="250000" min="0" step="1000"></td></tr>
          <tr><td>Stamp Duty (Â£)</td><td><input type="number" id="inStamp" value="3000" min="0"></td></tr>
          <tr><td>Legal/Agent Fees (Â£)</td><td><input type="number" id="inFeesAcq" value="4000" min="0"></td></tr>
        </table>
     
        <div class="section-header">2. The Works (Value Add)</div>
        <table>
          <tr><td>Refurb/Build Cost (Â£)</td><td><input type="number" id="inRefurb" value="35000" min="0" step="500"></td></tr>
          <tr><td>Contingency (%)</td><td><input type="number" id="inCont" value="10" min="0" step="1"></td></tr>
          <tr><td>Works Duration (Months)</td><td><input type="number" id="inWorksTerm" value="6" min="1" step="1"></td></tr>
          <tr><td><b><span class="help" title="Gross Development Value (End Value)">Target GDV</span></b></td><td><input type="number" id="inGdv" value="400000" min="0" step="1000" style="font-weight:bold; border-color:#27ae60"></td></tr>
        </table>
      </div>

      <div>
        <div class="section-header">3a. Bridging Finance (Entry)</div>
        <table>
          <tr><td>Gross Loan Amount (Â£)</td><td><input type="number" id="inBridgeGross" value="200000" min="0" step="1000"></td></tr>
          <tr><td>Rate (Monthly %)</td><td><input type="number" id="inBridgeRate" value="0.85" step="0.01" min="0"></td></tr>
          <tr><td>Term (Months)</td><td><input type="number" id="inBridgeTerm" value="12" min="1" step="1"></td></tr>
          <tr><td>Arrangement Fee (%)</td><td><input type="number" id="inBridgeArr" value="2.0" step="0.1" min="0"></td></tr>
          <tr><td>Exit Fee (%)</td><td><input type="number" id="inBridgeExit" value="0" step="0.1" min="0"></td></tr>
        </table>

        <div class="section-header">3b. Refinance (Exit)</div>
        <table>
           <tr><td>Projected Rent (pcm)</td><td><input type="number" id="inRent" value="2000" min="0" step="50"></td></tr>
           <tr><td><span class="help" title="Operating Expenses (Management, Void, Maintenance)">OpEx/Voids (%)</span></td><td><input type="number" id="inOpex" value="15" min="0" step="1"></td></tr>
           <tr><td><span class="help" title="Maximum Loan to Value based on Valuation">Max LTV Cap (%)</span></td><td><input type="number" id="inRefiLtv" value="75" min="0" max="100" step="5"></td></tr>
           <tr>
             <td><span class="help" title="Interest Coverage Ratio (Rent vs Interest)">ICR Test</span></td>
             <td>
               <select id="inIcrType">
                 <option value="1.45">Individual/HMO (145%)</option>
                 <option value="1.25">Ltd Co/Basic (125%)</option>
               </select>
             </td>
           </tr>
           <tr>
             <td>Stress Rate (2-Yr)</td>
             <td><input type="number" id="inStressStd" value="7.5" step="0.1" min="0.1"><span class="note">Typ: 5.5% or PayRate+2%</span></td>
           </tr>
           <tr>
             <td>Stress Rate (5-Yr)</td>
             <td><input type="number" id="inStress5Yr" value="5.5" step="0.1" min="0.1"><span class="note">Typ: Pay Rate (e.g. 5.5%)</span></td>
           </tr>
           <tr><td>Mortgage Interest Rate (%)</td><td><input type="number" id="inMortRate" value="5.5" step="0.1" min="0"></td></tr>
        </table>
      </div>
    </div>
  </div>
 
  <div id="tab-outputs" class="tabpage">
    <div class="kpiGrid">
      
      <div class="card">
        <h3>Capital Stack (Costs)</h3>
        <div class="body">
          <table>
            <tr><td>Purchase Price</td><td class="right" id="outPurch">-</td></tr>
            <tr><td>Buying Costs</td><td class="right" id="outAcqCosts">-</td></tr>
            <tr><td>Refurbishment (inc Cont)</td><td class="right" id="outRefurb">-</td></tr>
            <tr><td>Bridging Interest (Retained)</td><td class="right" id="outBridgeInt">-</td></tr>
            <tr><td>Bridging Fees (Arr + Exit)</td><td class="right" id="outBridgeFees">-</td></tr>
            <tr style="background:#eef2f5;font-weight:bold"><td>Total GDC (Cost)</td><td class="right" id="outGdc">-</td></tr>
          </table>
        </div>
      </div>

      <div class="card">
        <h3>The Exit (Refinance)</h3>
        <div class="body">
          <table>
            <tr><td>New Valuation (GDV)</td><td class="right" id="outGdv">-</td></tr>
            <tr><td><b>New Mortgage (5-Yr)</b></td><td class="right highlight-green" id="outRefiLoan">-</td></tr>
            <tr><td>Bridge Redemption</td><td class="right" style="color:#c0392b" id="outRedemption">-</td></tr>
            <tr style="border-top: 2px solid #333; font-weight:bold">
               <td>Money Left In Deal</td>
               <td class="right" id="outLeftIn">-</td>
            </tr>
            <tr><td><small><i>(Total GDC - New Mortgage)</i></small></td><td></td></tr>
          </table>
        </div>
      </div>
      
      <div class="card" style="grid-column: 1 / -1;">
        <h3>Risk Analysis (Stress Test)</h3>
        <div class="body">
          <table id="tblStress">
             <thead>
               <tr style="background:#f9f9f9;">
                 <th>Scenario</th>
                 <th class="right">Money Left In</th>
                 <th class="right">Profit (Paper)</th>
                 <th class="right">ROI</th>
               </tr>
             </thead>
             <tbody>
               <tr>
                 <td><b>Base Case</b></td>
                 <td class="right" id="riskBaseMoney">-</td>
                 <td class="right" id="riskBaseProf">-</td>
                 <td class="right" id="riskBaseRoi">-</td>
               </tr>
               <tr>
                 <td style="color:#c0392b"><b>Cost Overrun (+10%)</b></td>
                 <td class="right" id="riskCostMoney">-</td>
                 <td class="right" id="riskCostProf">-</td>
                 <td class="right" id="riskCostRoi">-</td>
               </tr>
               <tr>
                 <td style="color:#e67e22"><b>Market Dip (-10% GDV)</b></td>
                 <td class="right" id="riskValMoney">-</td>
                 <td class="right" id="riskValProf">-</td>
                 <td class="right" id="riskValRoi">-</td>
               </tr>
             </tbody>
          </table>
          <p class="disclaimer">Cost Overrun assumes +10% on Refurbishment costs. Market Dip assumes -10% on End Value (GDV).</p>
        </div>
      </div>

    </div>
  </div>
 
  <div id="tab-cash" class="tabpage">
    <div class="card">
     <h3>Annual Cashflow (Post-Refinance)</h3>
      <div class="body">
        <table id="tblCash">
          <thead><tr><th>Year</th><th>Gross Rent</th><th>Expenses</th><th>Mortgage</th><th>Net Cash</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
 
</div>
 
<script>
/* ----------------- Helpers ----------------- */
const el = (id) => document.getElementById(id);
const val = (id) => parseFloat(el(id)?.value) || 0;
const fmtGBP = (n) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(n);
const fmtPct = (n) => (n).toFixed(2) + "%";
const clamp = (n, min, max) => Math.min(Math.max(n, min), max); 

/* ----------------- Chart Instances ----------------- */
let chartLev = null;
let chartCosts = null;

function initCharts() {
  // Chart 1: Leverage
  const ctxLev = document.getElementById('chartLeverage').getContext('2d');
  chartLev = new Chart(ctxLev, {
    type: 'bar',
    data: {
      labels: ['2-Year (High Stress)', '5-Year (Low Stress)'],
      datasets: [{
        label: 'Max Borrowing Capacity (Â£)',
        data: [0, 0],
        backgroundColor: ['#95a5a6', '#27ae60'],
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });

  // Chart 2: Costs
  const ctxCosts = document.getElementById('chartCosts').getContext('2d');
  chartCosts = new Chart(ctxCosts, {
    type: 'doughnut',
    data: {
      labels: ['Purchase', 'Works', 'Finance', 'Fees'],
      datasets: [{
        data: [0, 0, 0, 0],
        backgroundColor: ['#2c3e50', '#e67e22', '#c0392b', '#7f8c8d'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'right' } }
    }
  });
}

function updateCharts(res) {
    if(!chartLev || !chartCosts) return;

    // Update Leverage Chart
    chartLev.data.datasets[0].data = [res.maxLoanStd, res.maxLoan5yr];
    chartLev.update();

    // Update Costs Chart
    const v = res.v;
    chartCosts.data.datasets[0].data = [
        v.purch, 
        v.refurb, 
        res.totalFinanceCost, 
        v.acqFees
    ];
    chartCosts.update();
}

/* ----------------- Reset ----------------- */
let resetArmed = false;
let resetTimer = null;
 
function setResetButtonLabel() {
  const b = el("btnResetZero");
  if (!b) return;
  b.textContent = resetArmed ? "Click again to confirm" : "Reset Inputs";
}
 
function resetToZeroImmediate() {
 document.querySelectorAll('input[type="number"]').forEach(input => {
     const id = input.id || "";
     if(id.startsWith("inStress") || id.startsWith("inRefiLtv") || id.startsWith("inOpex") || id.startsWith("inCont") || id.startsWith("inBridgeRate")) {
         return; 
     }
     input.value = 0; 
 });
 document.querySelectorAll('select').forEach(select => { select.selectedIndex = 0; });
 updateUI();
}
 
function handleResetClick() {
  if (!resetArmed) {
    resetArmed = true;
    setResetButtonLabel();
    clearTimeout(resetTimer);
    resetTimer = setTimeout(() => { resetArmed = false; setResetButtonLabel(); }, 4000);
    return;
  }
  resetArmed = false;
  clearTimeout(resetTimer);
  setResetButtonLabel();
  resetToZeroImmediate();
}

/* ----------------- Email Handler (LAYOUT FIX) ----------------- */
function handleEmailSummary() {
    const res = calculate();
    const v = res.v;
    
    // Formatting helper
    const line = "----------------------------------------";
    
    // Detailed structured body
    const body = `EAS FINANCE | DEAL ANALYSIS SUMMARY
${line}

1. SCENARIO & ACQUISITION
Purchase Price:     ${fmtGBP(v.purch)}
Stamp Duty:         ${fmtGBP(val("inStamp"))}
Legal/Agent Fees:   ${fmtGBP(val("inFeesAcq"))}
Total Buying Costs: ${fmtGBP(v.acqFees)}

2. WORKS & VALUE ADD
Refurb Cost:        ${fmtGBP(val("inRefurb"))}
Contingency:        ${val("inCont")}%
Works Duration:     ${v.works} months
TARGET GDV:         ${fmtGBP(v.gdv)}

3. BRIDGING FINANCE (The Entry)
Gross Loan:         ${fmtGBP(v.bGross)}
Interest Rate:      ${v.bRate}% pm
Term:               ${v.bTerm} months
Retained Interest:  ${fmtGBP(res.bridgeInterest)}
Net Advance:        ${fmtGBP(res.bridgeNet)}

4. REFINANCE EXIT (The Strategy)
Proj. Rent:         ${fmtGBP(v.rent)}/mo (${fmtGBP(v.rent*12)}/yr)
OpEx / Voids:       ${val("inOpex")}%
LTV Cap:            ${val("inRefiLtv")}%
Stress Test Used:   ${v.stress5yr*100}% (5-Year Fixed)

5. FINANCIAL OUTCOME (The Results)
Total GDC:          ${fmtGBP(res.gdc)}
Max Refi Loan:      ${fmtGBP(res.maxLoan5yr)}
Paper Uplift:       ${fmtGBP(res.profit)}
ROI (Cash on Cash): ${res.moneyLeftIn <= 0 ? "Infinite" : fmtPct(res.roi * 100)}

${line}
>>> MONEY LEFT IN DEAL: ${fmtGBP(res.moneyLeftIn)} <<<
${line}

If you would like to explore this project with us, then email your output to service@easfinance.co.uk`;

    // Opens email with BLANK recipient so user can choose to send to self or EAS
    window.location.href = `mailto:?subject=${encodeURIComponent("Deal Analysis - " + fmtGBP(v.purch))}&body=${encodeURIComponent(body)}`;
}
 
/* ----------------- Finance Engine ----------------- */
function calculate(overrideV = null) {
  let v;
  if (overrideV) {
      v = overrideV;
  } else {
      v = {
        purch: Math.max(0, val("inPurchase")),
        acqFees: Math.max(0, val("inStamp") + val("inFeesAcq")),
        refurb: Math.max(0, val("inRefurb")) * (1 + val("inCont")/100),
        works: val("inWorksTerm"), // Added for email export
        gdv: Math.max(0, val("inGdv")),
        
        bGross: Math.max(0, val("inBridgeGross")),
        bRate: val("inBridgeRate"),
        bTerm: val("inBridgeTerm"),
        bArr: val("inBridgeArr"),
        bExit: val("inBridgeExit"),
        
        rent: Math.max(0, val("inRent")),
        opex: val("inOpex") / 100,
        ltvCap: val("inRefiLtv") / 100,
        icr: parseFloat(el("inIcrType").value),
        stressStd: clamp(val("inStressStd") / 100, 0.001, 10),
        stress5yr: clamp(val("inStress5Yr") / 100, 0.001, 10),
        mortRate: val("inMortRate") / 100
      };
  }

  const bridgeInterest = v.bGross * (v.bRate/100) * v.bTerm; 
  const bridgeArrFee = v.bGross * (v.bArr/100);
  const bridgeExitFee = v.bGross * (v.bExit/100);
  const bridgeNet = v.bGross - bridgeInterest - bridgeArrFee;
  const totalFinanceCost = bridgeInterest + bridgeArrFee + bridgeExitFee;
  const gdc = v.purch + v.acqFees + v.refurb + totalFinanceCost;

  const annualRent = v.rent * 12;
  const maxLoanIcrStd = annualRent / (v.icr * v.stressStd);
  const maxLoanLtv = v.gdv * v.ltvCap;
  const finalLoanStd = Math.min(maxLoanIcrStd, maxLoanLtv);

  const maxLoanIcr5yr = annualRent / (v.icr * v.stress5yr);
  const finalLoan5yr = Math.min(maxLoanIcr5yr, maxLoanLtv);

  const mortgageAmount = finalLoan5yr;
  const bridgeRedemption = v.bGross + bridgeExitFee; 
  const moneyLeftIn = gdc - mortgageAmount;
  const profit = v.gdv - gdc;
  
  const grossRentYear = v.rent * 12;
  const opexYear = grossRentYear * v.opex;
  const debtServiceYear = mortgageAmount * v.mortRate; 
  const netCashflow = grossRentYear - opexYear - debtServiceYear;
  
  const netYield = (gdc > 0) ? (grossRentYear - opexYear) / gdc : 0;
  const roi = (moneyLeftIn > 0) ? (netCashflow / moneyLeftIn) : 0; 

  return { 
    v, gdc, bridgeInterest, bridgeArrFee, bridgeExitFee, totalFinanceCost,
    bridgeNet, bridgeRedemption,
    maxLoanStd: finalLoanStd, 
    maxLoan5yr: finalLoan5yr,
    moneyLeftIn, profit, netCashflow, netYield, roi
  };
}
 
function updateUI() {
  const res = calculate();
  const v = res.v;
  const set = (id, value) => { const e = el(id); if (e) e.textContent = value; };
  
  set("kpiGdc", fmtGBP(res.gdc));
  set("kpiMoneyLeftIn", fmtGBP(res.moneyLeftIn));
  
  const elLeftIn = el("kpiMoneyLeftIn");
  if(res.moneyLeftIn <= 0) {
      elLeftIn.textContent = fmtGBP(Math.abs(res.moneyLeftIn)) + " (CASH OUT)";
      elLeftIn.className = "cellOutput highlight-green";
  } else {
      elLeftIn.className = "cellOutput highlight-red";
  }

  set("kpiProfit", fmtGBP(res.profit));
  set("kpiRoi", (res.moneyLeftIn <= 0) ? "Inf%" : fmtPct(res.roi * 100));
  set("kpiYield", fmtPct(res.netYield * 100));

  set("kpiStressStd", fmtPct(v.stressStd * 100));
  set("kpiStress5yr", fmtPct(v.stress5yr * 100));
  set("kpiLoan2yr", fmtGBP(res.maxLoanStd));
  set("kpiLoan5yr", fmtGBP(res.maxLoan5yr));
  
  const diff = Math.max(0, res.maxLoan5yr - res.maxLoanStd);
  set("kpiExtraLev", fmtGBP(diff));
  
  set("outPurch", fmtGBP(v.purch));
  set("outAcqCosts", fmtGBP(v.acqFees));
  set("outRefurb", fmtGBP(v.refurb));
  set("outBridgeInt", fmtGBP(res.bridgeInterest));
  set("outBridgeFees", fmtGBP(res.bridgeArrFee + res.bridgeExitFee));
  set("outGdc", fmtGBP(res.gdc));
  
  set("outGdv", fmtGBP(v.gdv));
  set("outRefiLoan", fmtGBP(res.maxLoan5yr));
  set("outRedemption", fmtGBP(res.bridgeRedemption));
  set("outLeftIn", fmtGBP(res.moneyLeftIn));
  
  renderCashflowTable(v.rent * 12, v.opex, res.maxLoan5yr, v.mortRate);
  updateRiskAnalysis(v);
  updateCharts(res);
}

function updateRiskAnalysis(baseV) {
    const base = calculate(baseV);
    el("riskBaseMoney").textContent = fmtGBP(base.moneyLeftIn);
    el("riskBaseProf").textContent = fmtGBP(base.profit);
    el("riskBaseRoi").textContent = (base.moneyLeftIn <= 0) ? "Inf%" : fmtPct(base.roi * 100);

    const costV = Object.assign({}, baseV);
    costV.refurb = baseV.refurb * 1.10; 
    const costRes = calculate(costV);
    el("riskCostMoney").textContent = fmtGBP(costRes.moneyLeftIn);
    el("riskCostProf").textContent = fmtGBP(costRes.profit);
    el("riskCostRoi").textContent = (costRes.moneyLeftIn <= 0) ? "Inf%" : fmtPct(costRes.roi * 100);

    const valV = Object.assign({}, baseV);
    valV.gdv = baseV.gdv * 0.90;
    const valRes = calculate(valV);
    el("riskValMoney").textContent = fmtGBP(valRes.moneyLeftIn);
    el("riskValProf").textContent = fmtGBP(valRes.profit);
    el("riskValRoi").textContent = (valRes.moneyLeftIn <= 0) ? "Inf%" : fmtPct(valRes.roi * 100);
}
 
function renderCashflowTable(grossRent, opexPct, loan, rate) {
  const tbody = el("tblCash").querySelector("tbody");
  if(!tbody) return;
  tbody.innerHTML = "";
  for(let y=1; y<=5; y++) {
      const growth = Math.pow(1.03, y-1);
      const r = grossRent * growth;
      const exp = r * opexPct;
      const debt = loan * rate;
      const net = r - exp - debt;
      
      tbody.innerHTML += `<tr>
        <td>${y}</td>
        <td>${fmtGBP(r)}</td>
        <td>${fmtGBP(exp)}</td>
        <td>${fmtGBP(debt)}</td>
        <td><b>${fmtGBP(net)}</b></td>
      </tr>`;
  }
}
 
function wireEvents() {
  const resetBtn = el("btnResetZero");
  if (resetBtn) resetBtn.addEventListener("click", handleResetClick);

  const emailBtn = el("btnEmailQuote");
  if (emailBtn) emailBtn.addEventListener("click", handleEmailSummary);
  
  setResetButtonLabel();
  
  document.querySelectorAll('.tabbtn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tabpage').forEach(e => e.classList.remove('active'));
        el('tab-' + btn.dataset.tab).classList.add('active');
        document.querySelectorAll('.tabbtn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        // Fix: Charts sometimes need a resize trigger when tab becomes visible
        if(btn.dataset.tab === 'dash' && chartLev) {
            chartLev.resize();
            chartCosts.resize();
        }
    });
  });
  
  document.querySelectorAll('input, select').forEach(i => {
    i.addEventListener('input', updateUI);
    i.addEventListener('change', updateUI);
  });
  
  initCharts();
  updateUI();
}

wireEvents();
</script>
</body>
</html>
